name: Publish to PyPI and Trigger Conda-Forge

on:
  release:
    types: [created]
  workflow_dispatch:  # Allow manual triggering

jobs:
  build-and-publish:
    name: Build and Publish to PyPI
    runs-on: ubuntu-latest

    permissions:
      contents: read
      id-token: write  # Required for OIDC

    outputs:
      version: ${{ steps.version.outputs.version }}
      sha256: ${{ steps.sha256.outputs.sha256 }}

    steps:
    - uses: actions/checkout@v4

    - name: Install uv
      uses: astral-sh/setup-uv@v2

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Sync dependencies with uv
      run: uv sync --group release

    - name: Build package with flit
      run: uv run flit build

    - name: Publish to PyPI
      uses: pypa/gh-action-pypi-publish@release/v1
      with:
        packages-dir: dist/

    - name: Extract version
      id: version
      run: |
        VERSION=${{ github.event.release.tag_name }}
        VERSION=${VERSION#v}  # Remove 'v' prefix if present
        echo "version=$VERSION" >> $GITHUB_OUTPUT

    - name: Compute SHA256 hash
      id: sha256
      run: |
        SHA256=$(sha256sum dist/submitthem-${{ steps.version.outputs.version }}.tar.gz | awk '{print $1}')
        echo "sha256=$SHA256" >> $GITHUB_OUTPUT
        echo "âœ… SHA256 computed: $SHA256"

    - name: Display summary
      run: |
        echo "## ğŸ‰ Published to PyPI" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Version**: ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
        echo "- **SHA256**: ${{ steps.sha256.outputs.sha256 }}" >> $GITHUB_STEP_SUMMARY

  trigger-feedstock:
    name: Trigger Feedstock Update
    needs: build-and-publish
    runs-on: ubuntu-latest

    steps:
    - name: Trigger feedstock repository
      uses: peter-evans/repository-dispatch@v2
      with:
        token: ${{ secrets.FEEDSTOCK_TRIGGER_TOKEN }}
        repository: xroynard/submitthem-feedstock
        event-type: update-recipe
        client-payload: |
          {
            "version": "${{ needs.build-and-publish.outputs.version }}",
            "sha256": "${{ needs.build-and-publish.outputs.sha256 }}"
          }

    - name: Comment on release
      uses: actions/github-script@v6
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `ğŸ‰ **Released to PyPI**\n\nâœ… Version: \`${{ needs.build-and-publish.outputs.version }}\`\nâœ… SHA256: \`${{ needs.build-and-publish.outputs.sha256 }}\`\n\nğŸ Conda-forge feedstock update triggered!\nCheck: https://github.com/xroynard/submitthem-feedstock/pulls`
          })

    - name: Trigger conda-forge webservices
      uses: conda-forge/webservices-dispatch-action@main
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        feedstock_name: submitthem-feedstock
